<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>KVS by synrc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">KVS</h1>
      <h2 class="project-tagline">Erlang Data Framework with Sequential Consistency</h2>
      <a href="https://github.com/synrc/kvs" class="btn">View on GitHub</a>
      <a href="https://github.com/synrc/kvs/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/synrc/kvs/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="kvs-erlang-abstract-term-database" class="anchor" href="#kvs-erlang-abstract-term-database" aria-hidden="true"><span class="octicon octicon-link"></span></a>KVS: Erlang Abstract Term Database</h1>

<p>Online Presentation: <a href="http://slid.es/maximsokhatsky/kvs">http://slid.es/maximsokhatsky/kvs</a></p>

<h2>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Features</h2>

<ul>
<li>Polymorphic Tuples</li>
<li>Managing Linked-Lists</li>
<li>Various Backends Support: Mnesia, Riak, KAI, Redis</li>
<li>Sequential Consistency via Feed Server</li>
<li>Basic Schema for Social Sites and Accounting</li>
<li>Extendable Schema</li>
<li>Supports Secondary Indexes for KAI, Mnesia and Riak</li>
<li>Change Backends on-the-fly</li>
<li>Supports Multiple backends at the same time</li>
<li>Xen Ready</li>
</ul>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h2>

<p>In rebar.config:</p>

<div class="highlight highlight-erlang"><pre>    {<span class="pl-c1">kvs</span>, <span class="pl-s"><span class="pl-pds">"</span>.*<span class="pl-pds">"</span></span>, {<span class="pl-c1">git</span>, <span class="pl-s"><span class="pl-pds">"</span>git://github.com/synrc/kvs<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>HEAD<span class="pl-pds">"</span></span>}}</pre></div>

<p>Redis also need to add:</p>

<div class="highlight highlight-erlang"><pre>    {<span class="pl-c1">eredis</span>, <span class="pl-s"><span class="pl-pds">"</span>.*<span class="pl-pds">"</span></span>, {<span class="pl-c1">git</span>, <span class="pl-s"><span class="pl-pds">"</span>git://github.com/wooga/eredis<span class="pl-pds">"</span></span>, {<span class="pl-c1">tag</span>, <span class="pl-s"><span class="pl-pds">"</span>v1.0.6<span class="pl-pds">"</span></span>} }}</pre></div>

<h2>
<a id="models" class="anchor" href="#models" aria-hidden="true"><span class="octicon octicon-link"></span></a>Models</h2>

<p>We have built with KVS a number of applications and came up with schema samples.
We grouped schemas by three category. KVS hides database access behind backend drivers
and provides high-level rich API to stored and extend following data:</p>

<ul>
<li>
<strong>Core</strong> — Acl, Users, Subscriptions, Feeds, Entries, Comments</li>
<li>
<strong>Banking</strong> — Account, Customer, Transaction, Item, Currency, Program, Card, Cashback</li>
<li>
<strong>Social</strong> — Group, Meeting, Payment, Product, Purchase</li>
</ul>

<h2>
<a id="applications" class="anchor" href="#applications" aria-hidden="true"><span class="octicon octicon-link"></span></a>Applications</h2>

<p>This Framework provides also a <strong>feed</strong> application for sequential consistency
and <strong>cr</strong> application for chain replication database on top of <strong>kvs</strong>.
All write requests with given object key will be handled by single processes
so you may not worry about concurrent changes of user feed tops.</p>

<p>All write operations that are made to data with secondary indexes,
i.e. not like linked lists could be potentially handled without feed_server.
But some KV storages are not supporting secondary indexes so use these backends carefully.</p>

<h2>
<a id="store-backends" class="anchor" href="#store-backends" aria-hidden="true"><span class="octicon octicon-link"></span></a>Store Backends</h2>

<p>Currently <strong>kvs</strong> includes following store backends:</p>

<ul>
<li>Mnesia</li>
<li>Riak</li>
<li>KAI</li>
<li>Filesystem</li>
<li>Redis</li>
</ul>

<h2>
<a id="configuring" class="anchor" href="#configuring" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring</h2>

<p>First of all you need to tune your backend in the kvs application:</p>

<div class="highlight highlight-erlang"><pre>{<span class="pl-c1">kvs</span>, [{<span class="pl-c1">dba</span>,<span class="pl-c1">store_mnesia</span>}]},</pre></div>

<p>Try to check it:</p>

<div class="highlight highlight-erlang"><pre><span class="pl-c1">1</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">config</span>(<span class="pl-c1">dba</span>).
<span class="pl-c1">store_kai</span>

<span class="pl-c1">2</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">version</span>().
{<span class="pl-c1">version</span>,<span class="pl-s"><span class="pl-pds">"</span>KVS KAI PURE XEN<span class="pl-pds">"</span></span>}</pre></div>

<p>Create database for single node:</p>

<div class="highlight highlight-erlang"><pre><span class="pl-c1">3</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">join</span>().
[<span class="pl-c1">kvs</span>] <span class="pl-smi">Mnesia</span> <span class="pl-smi">Init</span>
<span class="pl-c1">ok</span></pre></div>

<p>You can also create database by joining to existing cluster:</p>

<div class="highlight highlight-erlang"><pre><span class="pl-c1">3</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">join</span>(<span class="pl-c1">'kvs@synrc.com'</span>).</pre></div>

<p>In that case you don't need to initialize the database
to check table packages included into the schema:</p>

<div class="highlight highlight-erlang"><pre><span class="pl-c1">4</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">dir</span>().
[{<span class="pl-c1">table</span>,<span class="pl-s"><span class="pl-pds">"</span>id_seq<span class="pl-pds">"</span></span>},
 {<span class="pl-c1">table</span>,<span class="pl-s"><span class="pl-pds">"</span>subscription<span class="pl-pds">"</span></span>},
 {<span class="pl-c1">table</span>,<span class="pl-s"><span class="pl-pds">"</span>feed<span class="pl-pds">"</span></span>},
 {<span class="pl-c1">table</span>,<span class="pl-s"><span class="pl-pds">"</span>comment<span class="pl-pds">"</span></span>},
 {<span class="pl-c1">table</span>,<span class="pl-s"><span class="pl-pds">"</span>entry<span class="pl-pds">"</span></span>},
 {<span class="pl-c1">table</span>,<span class="pl-s"><span class="pl-pds">"</span>access<span class="pl-pds">"</span></span>},
 {<span class="pl-c1">table</span>,<span class="pl-s"><span class="pl-pds">"</span>acl<span class="pl-pds">"</span></span>},
 {<span class="pl-c1">table</span>,<span class="pl-s"><span class="pl-pds">"</span>user<span class="pl-pds">"</span></span>}]</pre></div>

<h2>
<a id="operations" class="anchor" href="#operations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Operations</h2>

<p>Try to add some data:</p>

<div class="highlight highlight-erlang"><pre><span class="pl-c1">1</span><span class="pl-k">&gt;</span> <span class="pl-en">rr</span>(<span class="pl-c1">kvs</span>).
<span class="pl-c1">2</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">put</span>(<span class="pl-k">#</span><span class="pl-en">user</span>{<span class="pl-smi">id</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>maxim@synrc.com<span class="pl-pds">"</span></span>}).
<span class="pl-c1">ok</span>
<span class="pl-c1">3</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">get</span>(<span class="pl-c1">user</span>,<span class="pl-s"><span class="pl-pds">"</span>maxim@synrc.com<span class="pl-pds">"</span></span>).
<span class="pl-k">#</span><span class="pl-en">user</span>{<span class="pl-smi">id</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>maxim@synrc.com<span class="pl-pds">"</span></span>,<span class="pl-smi">container</span> <span class="pl-k">=</span> <span class="pl-c1">feed</span>,...}
<span class="pl-c1">4</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">put</span>(<span class="pl-k">#</span><span class="pl-en">user</span>{<span class="pl-smi">id</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>doxtop@synrc.com<span class="pl-pds">"</span></span>}).
<span class="pl-c1">5</span><span class="pl-k">&gt;</span> <span class="pl-en">length</span>(<span class="pl-en">kvs</span>:<span class="pl-en">all</span>(<span class="pl-c1">user</span>)).
<span class="pl-c1">2</span></pre></div>

<h2>
<a id="polymorphic-records" class="anchor" href="#polymorphic-records" aria-hidden="true"><span class="octicon octicon-link"></span></a>Polymorphic Records</h2>

<p>The data in KVS represented as plain Erlang records. The first element of the tuple
as usual indicates the name of bucket. And the second element usually corresponds
to the index key field. Additional secondary indexes could be applied for stores
that supports 2i, e.g. kai, mnesia, riak.</p>

<h2>
<a id="iterators" class="anchor" href="#iterators" aria-hidden="true"><span class="octicon octicon-link"></span></a>Iterators</h2>

<p>All record could be chained into the double-linked lists in the database.
So you can inherit from the ITERATOR record just like that:</p>

<div class="highlight highlight-erlang"><pre>-<span class="pl-k">record</span>(<span class="pl-en">iterator</span>, {<span class="pl-smi">id</span>,<span class="pl-smi">version</span>,
                   <span class="pl-smi">container</span>,<span class="pl-smi">feed_id</span>,<span class="pl-smi">prev</span>,
                   <span class="pl-smi">next</span>,<span class="pl-smi">feeds</span><span class="pl-k">=</span>[],<span class="pl-smi">guard</span>,<span class="pl-smi">etc</span>}).</pre></div>

<p>The layout of iterators are following:</p>

<div class="highlight highlight-erlang"><pre><span class="pl-k">&gt;</span> <span class="pl-en">lists</span>:<span class="pl-en">zip</span>(<span class="pl-en">lists</span>:<span class="pl-en">seq</span>(<span class="pl-c1">1</span>,<span class="pl-en">length</span>((<span class="pl-en">kvs</span>:<span class="pl-en">table</span>(<span class="pl-c1">operation</span>))<span class="pl-k">#</span><span class="pl-en">table</span>.<span class="pl-smi">fields</span>)),
            (<span class="pl-en">kvs</span>:<span class="pl-en">table</span>(<span class="pl-c1">operation</span>))<span class="pl-k">#</span><span class="pl-en">table</span>.<span class="pl-smi">fields</span>).

[{<span class="pl-c1">1</span>,<span class="pl-c1">id</span>},
 {<span class="pl-c1">2</span>,<span class="pl-c1">version</span>},
 {<span class="pl-c1">3</span>,<span class="pl-c1">container</span>},
 {<span class="pl-c1">4</span>,<span class="pl-c1">feed_id</span>},
 {<span class="pl-c1">5</span>,<span class="pl-c1">prev</span>},
 {<span class="pl-c1">6</span>,<span class="pl-c1">next</span>},
 {<span class="pl-c1">7</span>,<span class="pl-c1">feeds</span>},
 {<span class="pl-c1">8</span>,<span class="pl-c1">guard</span>},
 {<span class="pl-c1">9</span>,<span class="pl-c1">etc</span>},
 {<span class="pl-c1">10</span>,<span class="pl-c1">body</span>},
 {<span class="pl-c1">11</span>,<span class="pl-c1">name</span>},
 {<span class="pl-c1">12</span>,<span class="pl-c1">status</span>}]</pre></div>

<p>This means your table will support add/remove linked list operations to lists.</p>

<div class="highlight highlight-erlang"><pre><span class="pl-c1">1</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">add</span>(<span class="pl-k">#</span><span class="pl-en">user</span>{<span class="pl-smi">id</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>mes@ua.fm<span class="pl-pds">"</span></span>}).
<span class="pl-c1">2</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">add</span>(<span class="pl-k">#</span><span class="pl-en">user</span>{<span class="pl-smi">id</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>dox@ua.fm<span class="pl-pds">"</span></span>}).</pre></div>

<p>Read the chain (undefined means all)</p>

<div class="highlight highlight-erlang"><pre><span class="pl-c1">3</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">entries</span>(<span class="pl-en">kvs</span>:<span class="pl-en">get</span>(<span class="pl-c1">feed</span>, <span class="pl-c1">user</span>), <span class="pl-c1">user</span>, <span class="pl-c1">undefined</span>).
[<span class="pl-k">#</span><span class="pl-en">user</span>{<span class="pl-smi">id</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>mes@ua.fm<span class="pl-pds">"</span></span>},
 <span class="pl-k">#</span><span class="pl-en">user</span>{<span class="pl-smi">id</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>dox@ua.fm<span class="pl-pds">"</span></span>}]</pre></div>

<p>Read flat values by all keys from table:</p>

<div class="highlight highlight-erlang"><pre><span class="pl-c1">4</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">all</span>(<span class="pl-c1">user</span>).
[<span class="pl-k">#</span><span class="pl-en">user</span>{<span class="pl-smi">id</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>mes@ua.fm<span class="pl-pds">"</span></span>},
 <span class="pl-k">#</span><span class="pl-en">user</span>{<span class="pl-smi">id</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>dox@ua.fm<span class="pl-pds">"</span></span>}]</pre></div>

<h2>
<a id="containers" class="anchor" href="#containers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Containers</h2>

<p>If you are using iterators records this automatically means you are using containers.
Containers are just boxes for storing top/heads of the linked lists. Here is layout
of containers:</p>

<div class="highlight highlight-erlang"><pre>-<span class="pl-k">record</span>(<span class="pl-en">container</span>, {<span class="pl-smi">id</span>,<span class="pl-smi">top</span>,<span class="pl-smi">count</span>}).</pre></div>

<div class="highlight highlight-erlang"><pre><span class="pl-k">&gt;</span> <span class="pl-en">lists</span>:<span class="pl-en">zip</span>(<span class="pl-en">lists</span>:<span class="pl-en">seq</span>(<span class="pl-c1">1</span>,<span class="pl-en">length</span>((<span class="pl-en">kvs</span>:<span class="pl-en">table</span>(<span class="pl-c1">feed</span>))<span class="pl-k">#</span><span class="pl-en">table</span>.<span class="pl-smi">fields</span>)),
            (<span class="pl-en">kvs</span>:<span class="pl-en">table</span>(<span class="pl-c1">feed</span>))<span class="pl-k">#</span><span class="pl-en">table</span>.<span class="pl-smi">fields</span>).
[{<span class="pl-c1">1</span>,<span class="pl-c1">id</span>},
 {<span class="pl-c1">2</span>,<span class="pl-c1">top</span>},
 {<span class="pl-c1">3</span>,<span class="pl-c1">count</span>},
 {<span class="pl-c1">4</span>,<span class="pl-c1">aclver</span>}]</pre></div>

<h2>
<a id="extending-schema" class="anchor" href="#extending-schema" aria-hidden="true"><span class="octicon octicon-link"></span></a>Extending Schema</h2>

<p>Usually you need only specify custom mnesia indexes and tables tuning.
Riak, KAI and Redis backends don't need it. Group you table into table packages
represented as modules with handle_notice API.</p>

<div class="highlight highlight-erlang"><pre>-<span class="pl-k">module</span>(<span class="pl-en">kvs_feed</span>).
-<span class="pl-k">inclue_lib</span>(<span class="pl-s"><span class="pl-pds">"</span>kvs/include/kvs.hrl<span class="pl-pds">"</span></span>).

<span class="pl-en">metainfo</span>() <span class="pl-k">-&gt;</span> 
    <span class="pl-k">#</span><span class="pl-en">schema</span>{<span class="pl-smi">name</span><span class="pl-k">=</span><span class="pl-c1">kvs</span>,<span class="pl-smi">tables</span><span class="pl-k">=</span>[
        <span class="pl-k">#</span><span class="pl-en">table</span>{<span class="pl-smi">name</span><span class="pl-k">=</span><span class="pl-c1">feed</span>,<span class="pl-smi">container</span><span class="pl-k">=</span><span class="pl-c1">true</span>,<span class="pl-smi">fields</span><span class="pl-k">=</span><span class="pl-en">record_info</span>(<span class="pl-c1">fields</span>,<span class="pl-c1">feed</span>)},
        <span class="pl-k">#</span><span class="pl-en">table</span>{ <span class="pl-smi">name</span><span class="pl-k">=</span><span class="pl-c1">entry</span>,<span class="pl-smi">container</span><span class="pl-k">=</span><span class="pl-c1">feed</span>,<span class="pl-smi">fields</span><span class="pl-k">=</span><span class="pl-en">record_info</span>(<span class="pl-c1">fields</span>,<span class="pl-c1">entry</span>),
                <span class="pl-smi">keys</span><span class="pl-k">=</span>[<span class="pl-c1">feed_id</span>,<span class="pl-c1">entry_id</span>,<span class="pl-c1">from</span>]},
        <span class="pl-k">#</span><span class="pl-en">table</span>{<span class="pl-smi">name</span><span class="pl-k">=</span><span class="pl-c1">comment</span>,<span class="pl-smi">container</span><span class="pl-k">=</span><span class="pl-c1">feed</span>,<span class="pl-smi">fields</span><span class="pl-k">=</span><span class="pl-en">record_info</span>(<span class="pl-c1">fields</span>,<span class="pl-c1">comment</span>),
                <span class="pl-smi">keys</span><span class="pl-k">=</span>[<span class="pl-c1">entry_id</span>,<span class="pl-c1">author_id</span>]} ]}.</pre></div>

<p>And plug it into schema config:</p>

<div class="highlight highlight-erlang"><pre>{<span class="pl-c1">kvs</span>, {<span class="pl-c1">schema</span>,[<span class="pl-c1">kvs_user</span>,<span class="pl-c1">kvs_acl</span>,<span class="pl-c1">kvs_feed</span>,<span class="pl-c1">kvs_subscription</span>]}},</pre></div>

<p>And on database init</p>

<div class="highlight highlight-erlang"><pre><span class="pl-c1">1</span><span class="pl-k">&gt;</span> <span class="pl-en">kvs</span>:<span class="pl-en">join</span>().</pre></div>

<p>It will create your custom schema.</p>

<h2>
<a id="using-kvs-in-real-applications" class="anchor" href="#using-kvs-in-real-applications" aria-hidden="true"><span class="octicon octicon-link"></span></a>Using KVS in real applications</h2>

<p>Besides using KVS in production in a number of applications we have
built on top of KVS several products. The first product is Chain
Replication Database wit XA protocol. And second is social Feed
Server for web shops and social sites.</p>

<h3>
<a id="chain-replication-database" class="anchor" href="#chain-replication-database" aria-hidden="true"><span class="octicon octicon-link"></span></a>Chain Replication Database</h3>

<p>The <strong>kvs</strong> semantic is totally compatible with XA protocol.
Adding the object with PUT means only putting to database
while ADD operations provides linking to the chain's container.
Also linking operation LINK is provided separately.</p>

<div class="highlight highlight-erlang"><pre><span class="pl-en">dispatch</span>({<span class="pl-c1">prepare</span>,<span class="pl-v">_</span>,<span class="pl-v">_</span>,<span class="pl-smi">Tx</span>}, <span class="pl-k">#</span><span class="pl-en">state</span>{})  <span class="pl-k">-&gt;</span>
    <span class="pl-en">kvs</span>:<span class="pl-en">info</span>(<span class="pl-k">?</span><span class="pl-en">MODULE</span>,<span class="pl-s"><span class="pl-pds">"</span>KVS PUT <span class="pl-c1">~p</span>:<span class="pl-c1">~p~n</span><span class="pl-pds">"</span></span>,[<span class="pl-en">element</span>(<span class="pl-c1">1</span>,<span class="pl-smi">Tx</span>),<span class="pl-en">element</span>(<span class="pl-c1">2</span>,<span class="pl-smi">Tx</span>)]),
    <span class="pl-en">kvs</span>:<span class="pl-en">put</span>(<span class="pl-smi">Tx</span>);

<span class="pl-en">dispatch</span>({<span class="pl-c1">commit</span>,<span class="pl-v">_</span>,<span class="pl-v">_</span>,<span class="pl-smi">Tx</span>}, <span class="pl-k">#</span><span class="pl-en">state</span>{})  <span class="pl-k">-&gt;</span>
    <span class="pl-en">kvs</span>:<span class="pl-en">info</span>(<span class="pl-k">?</span><span class="pl-en">MODULE</span>,<span class="pl-s"><span class="pl-pds">"</span>KVS LINK <span class="pl-c1">~p</span>:<span class="pl-c1">~p~n</span><span class="pl-pds">"</span></span>,[<span class="pl-en">element</span>(<span class="pl-c1">1</span>,<span class="pl-smi">Tx</span>),<span class="pl-en">element</span>(<span class="pl-c1">2</span>,<span class="pl-smi">Tx</span>)]),
    <span class="pl-en">kvs</span>:<span class="pl-en">link</span>(<span class="pl-smi">Tx</span>);

<span class="pl-en">dispatch</span>({<span class="pl-c1">rollback</span>,<span class="pl-v">_</span>,<span class="pl-v">_</span>,<span class="pl-smi">Tx</span>}, <span class="pl-k">#</span><span class="pl-en">state</span>{})  <span class="pl-k">-&gt;</span>
    <span class="pl-en">kvs</span>:<span class="pl-en">info</span>(<span class="pl-k">?</span><span class="pl-en">MODULE</span>,<span class="pl-s"><span class="pl-pds">"</span>KVS REMOVE <span class="pl-c1">~p</span>:<span class="pl-c1">~p~n</span><span class="pl-pds">"</span></span>,[<span class="pl-en">element</span>(<span class="pl-c1">1</span>,<span class="pl-smi">Tx</span>),<span class="pl-en">element</span>(<span class="pl-c1">2</span>,<span class="pl-smi">Tx</span>)]),
    <span class="pl-en">kvs</span>:<span class="pl-en">remove</span>(<span class="pl-smi">Tx</span>);</pre></div>

<p>See: <a href="https://github.com/spawnproc/cr">https://github.com/spawnproc/cr</a></p>

<h3>
<a id="feeds-server" class="anchor" href="#feeds-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Feeds Server</h3>

<p>Here is Consumer behavior handlers of KVS FEEDS supervised processes</p>

<div class="highlight highlight-erlang"><pre><span class="pl-en">handle_notice</span>(  [<span class="pl-c1">kvs_feed</span>,<span class="pl-c1">user</span>,<span class="pl-smi">Owner</span>,<span class="pl-c1">entry</span>,<span class="pl-smi">Eid</span>,<span class="pl-c1">add</span>],
                [<span class="pl-k">#</span><span class="pl-en">entry</span>{<span class="pl-smi">feed_id</span><span class="pl-k">=</span><span class="pl-smi">Fid</span>}<span class="pl-k">=</span><span class="pl-smi">Entry</span>],
                <span class="pl-k">#</span><span class="pl-en">state</span>{<span class="pl-smi">feeds</span><span class="pl-k">=</span><span class="pl-smi">Feeds</span>}) <span class="pl-k">-&gt;</span>

                <span class="pl-k">case</span> <span class="pl-en">lists</span>:<span class="pl-en">keyfind</span>(<span class="pl-smi">Fid</span>,<span class="pl-c1">2</span>, <span class="pl-smi">S</span><span class="pl-k">#</span><span class="pl-en">state</span>.<span class="pl-smi">feeds</span>) <span class="pl-k">of</span>
                    <span class="pl-c1">false</span> -&gt; <span class="pl-c1">skip</span>;
                    {<span class="pl-v">_</span>,<span class="pl-v">_</span>} -&gt; <span class="pl-en">add_entry</span>(<span class="pl-smi">Eid</span>,<span class="pl-smi">Fid</span>,<span class="pl-smi">Entry</span>) <span class="pl-k">end</span>,
                {<span class="pl-c1">noreply</span>, <span class="pl-smi">S</span>};

<span class="pl-en">handle_notice</span>(  [<span class="pl-c1">kvs_feed</span>,<span class="pl-c1">user</span>,<span class="pl-smi">Owner</span>,<span class="pl-c1">entry</span>,{<span class="pl-smi">Eid</span>,<span class="pl-smi">FeedName</span>},<span class="pl-c1">edit</span>],
                [<span class="pl-k">#</span><span class="pl-en">entry</span>{<span class="pl-smi">feed_id</span><span class="pl-k">=</span><span class="pl-smi">Fid</span>}<span class="pl-k">=</span><span class="pl-smi">Entry</span>],
                <span class="pl-k">#</span><span class="pl-en">state</span>{<span class="pl-smi">feeds</span><span class="pl-k">=</span><span class="pl-smi">Feeds</span>}) <span class="pl-k">-&gt;</span>

                <span class="pl-k">case</span> <span class="pl-en">lists</span>:<span class="pl-en">keyfind</span>(<span class="pl-smi">FeedName</span>,<span class="pl-c1">1</span>,<span class="pl-smi">Feeds</span>) <span class="pl-k">of</span>
                    <span class="pl-c1">false</span> -&gt; <span class="pl-c1">skip</span>;
                    {<span class="pl-v">_</span>,<span class="pl-smi">Fid</span>}-&gt; <span class="pl-en">update_entry</span>(<span class="pl-smi">Eid</span>,<span class="pl-smi">Fid</span>,<span class="pl-smi">Entry</span>) <span class="pl-k">end</span>,
                {<span class="pl-c1">noreply</span>, <span class="pl-smi">S</span>};

<span class="pl-en">handle_notice</span>(  [<span class="pl-c1">kvs_feed</span>,<span class="pl-c1">user</span>,<span class="pl-smi">Owner</span>,<span class="pl-c1">entry</span>,<span class="pl-smi">Eid</span>,<span class="pl-c1">edit</span>],
                [<span class="pl-k">#</span><span class="pl-en">entry</span>{<span class="pl-smi">feed_id</span><span class="pl-k">=</span><span class="pl-smi">Fid</span>}<span class="pl-k">=</span><span class="pl-smi">Entry</span>],
                <span class="pl-k">#</span><span class="pl-en">state</span>{<span class="pl-smi">feeds</span><span class="pl-k">=</span><span class="pl-smi">Feeds</span>}) <span class="pl-k">-&gt;</span>

                <span class="pl-k">case</span> <span class="pl-en">lists</span>:<span class="pl-en">keyfind</span>(<span class="pl-smi">Fid</span>, <span class="pl-c1">2</span>, <span class="pl-smi">Feeds</span>) <span class="pl-k">of</span>
                    <span class="pl-c1">false</span> -&gt; <span class="pl-c1">skip</span>;
                    {<span class="pl-v">_</span>,<span class="pl-v">_</span>} -&gt; <span class="pl-en">update_entry</span>(<span class="pl-smi">Eid</span>,<span class="pl-smi">Fid</span>,<span class="pl-smi">Entry</span>) <span class="pl-k">end</span>,
                {<span class="pl-c1">noreply</span>, <span class="pl-smi">S</span>};</pre></div>

<p>Here is the private implementation</p>

<div class="highlight highlight-erlang"><pre><span class="pl-en">add_entry</span>(<span class="pl-smi">Eid</span>,<span class="pl-smi">Fid</span>,<span class="pl-smi">Entry</span>) <span class="pl-k">-&gt;</span>
    <span class="pl-smi">E</span> <span class="pl-k">=</span> <span class="pl-smi">Entry</span><span class="pl-k">#</span><span class="pl-en">entry</span>{<span class="pl-smi">id</span> <span class="pl-k">=</span> {<span class="pl-smi">Eid</span>, <span class="pl-smi">Fid</span>}, <span class="pl-smi">entry_id</span> <span class="pl-k">=</span> <span class="pl-smi">Eid</span>, <span class="pl-smi">feeds</span><span class="pl-k">=</span>[<span class="pl-c1">comments</span>]},
    <span class="pl-smi">Added</span> <span class="pl-k">=</span> <span class="pl-k">case</span> <span class="pl-en">kvs</span>:<span class="pl-en">add</span>(<span class="pl-smi">E</span>) <span class="pl-k">of</span> {<span class="pl-c1">error</span>, <span class="pl-smi">Err</span>} -&gt; {<span class="pl-c1">error</span>,<span class="pl-smi">Err</span>}; {<span class="pl-c1">ok</span>, <span class="pl-smi">En</span>} -&gt; <span class="pl-smi">En</span> <span class="pl-k">end</span>,
    <span class="pl-en">msg</span>:<span class="pl-en">notify</span>([<span class="pl-c1">kvs_feed</span>, <span class="pl-c1">entry</span>, {<span class="pl-smi">Eid</span>, <span class="pl-smi">Fid</span>}, <span class="pl-c1">added</span>], [<span class="pl-smi">Added</span>]).

<span class="pl-en">update_entry</span>(<span class="pl-smi">Eid</span>,<span class="pl-smi">Fid</span>,<span class="pl-smi">Entry</span>) <span class="pl-k">-&gt;</span> ...</pre></div>

<p>And that is how you can call it</p>

<div class="highlight highlight-erlang"><pre><span class="pl-en">kvs</span>:<span class="pl-en">notify</span>([<span class="pl-c1">kvs_feed</span>, <span class="pl-c1">user</span>, <span class="pl-s"><span class="pl-pds">"</span>maxim@synrc.com<span class="pl-pds">"</span></span>, <span class="pl-c1">entry</span>, <span class="pl-smi">Eid</span>, <span class="pl-c1">add</span>],
           [<span class="pl-k">#</span><span class="pl-en">entry</span>{}]).</pre></div>

<p>See: <a href="https://github.com/synrc/feeds">https://github.com/synrc/feeds</a></p>

<h2>
<a id="credits" class="anchor" href="#credits" aria-hidden="true"><span class="octicon octicon-link"></span></a>Credits</h2>

<ul>
<li>Maxim Sokhatsky</li>
<li>Andrii Zadorozhnii</li>
<li>Vladimir Kirillov</li>
<li>Alex Kalenuk</li>
<li>Sergey Polkovnikov</li>
<li>Andrey Martemyanov</li>
</ul>

<p>OM A HUM</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/synrc/kvs">KVS</a> is maintained by <a href="https://github.com/synrc">synrc</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>

